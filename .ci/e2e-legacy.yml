legacy-e2e:
  extends: .template.tests
  stage: test
  tags:
    - kubernetes01-gramax-5ghz
  image: gitlab.ics-it.ru:4567/ics/doc-reader:playwright-$BRANCH
  rules:
    - !reference [.condition, tests, base, rules]
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - !reference [.condition, core, rules]
    - !reference [.condition, tests, e2e, rules]
  variables:
    PORT: 5173
    PRODUCTION: 'false'
    GX_E2E_GITLAB_PUSH_REPO: test-push-$CI_COMMIT_SHORT_SHA
    KUBERNETES_MEMORY_REQUEST: '3Gi'
    KUBERNETES_CPU_REQUEST: '1.5'
    KUBERNETES_CPU_LIMIT: '4'
  before_script:
    - ./install-deps.sh --ci
  script:
    - nice -n 15 ionice -c 3 bun run --cwd apps/browser build
    - bun run --cwd apps/browser start &
    - nice -n -15 ionice -c 2 npm --prefix e2e run test

  after_script:
    - ./.ci/e2e/delete-repo.sh
  artifacts:
    when: always
    expire_in: 1 day
    paths:
      - e2e/report/
    reports:
      junit: e2e/junit*.xml

# legacy-e2e-next:
#   extends: legacy-e2e
#   tags:
#     - kubernetes01-gramax-5ghz
#   image: gitlab.ics-it.ru:4567/ics/doc-reader:playwright-$BRANCH
#   variables:
#     PORT: 5173
#     ADMIN_LOGIN: 1
#     ADMIN_PASSWORD: 1
#     ROOT_PATH: ${PWD}/x
#     PRODUCTION: 'false'
#     CARGO_HOME: '$CI_PROJECT_DIR/.cargo'
#     KUBERNETES_MEMORY_REQUEST: '4Gi'
#     KUBERNETES_CPU_REQUEST: '2'
#     KUBERNETES_CPU_LIMIT: '5'
#   before_script:
#     - ./install-deps.sh --ci --node
#     - mkdir -p $ROOT_PATH
#   script:
#     - nice -n 20 ionice -c 3 npm --prefix apps/next run build
#     - npm --prefix apps/next run start &
#     - nice -n -15 ionice -c 2 npm --prefix e2e run test:next

# legacy-e2e-static:
#   extends: .template.tests
#   stage: test
#   image: gitlab.ics-it.ru:4567/ics/doc-reader:playwright-$BRANCH
#   rules:
#     - !reference [.condition, tests, base, rules]
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#     - !reference [.condition, core, rules]
#     - !reference [.condition, tests, e2e, rules]
#   variables:
#     PORT: 5173
#     KUBERNETES_MEMORY_REQUEST: '4Gi'
#     KUBERNETES_CPU_REQUEST: '1.5'
#     KUBERNETES_CPU_LIMIT: '3'
#   before_script:
#     - ./install-deps.sh --ci
#     - ./.ci/e2e/repo-info.sh
#   script:
#     - nice -n 20 ionice -c 3 npm --prefix apps/gramax-cli run build

#     - nice -n 20 ionice -c 3 git clone https://git:$GX_E2E_GITLAB_TOKEN@$GX_E2E_GITLAB_URL/$GX_E2E_GITLAB_GROUP/$GX_E2E_GITLAB_TEST_REPO.git
#     - nice -n 20 ionice -c 3 npx --prefix apps/gramax-cli/dist gramax-cli build -s "$GX_E2E_GITLAB_TEST_REPO" --skip-check
#     # - npx http-server build &
#     # - nice -n -15 ionice -c 2 -n 3 npm --prefix e2e run test:static

#     - curl -fsSL https://raw.githubusercontent.com/tj/n/master/bin/n | bash -s 20
#     - node -v
#     - nice -n 20 ionice -c 2 -n 3 npx --prefix apps/gramax-cli/dist gramax-cli build -s "$GX_E2E_GITLAB_TEST_REPO" --skip-check
#   artifacts:
#     when: always
#     expire_in: 1 day
#     paths:
#       - e2e/report/
#     reports:
#       junit: e2e/junit*.xml

# run-e2e-enterprise:
#   extends: .template.tests
#   stage: test
#   image: gitlab.ics-it.ru:4567/ics/doc-reader:playwright-$BRANCH
#   rules:
#     - !reference [.condition, tests, base, rules]
#     - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
#     - !reference [.condition, core, rules]
#     - !reference [.condition, tests, e2e, rules]
#   variables:
#     PORT: 5173
#     PRODUCTION: "false"
#     GES_URL: https://enterprise.gramax.local
#     NODE_TLS_REJECT_UNAUTHORIZED: 0
#     ENTERPRISE_STORAGE_TYPE: local
#     GIT_SERVER_TOKEN: $ENTERPRISE_GIT_SERVER_TOKEN
#     GIT_PROJECT_PATH: $ENTERPRISE_GIT_PROJECT_PATH
#     KEYCLOAK_CLIENT_SECRET: $E2E_KEYCLOAK_CLIENT_SECRET
#   before_script:
#     - echo '127.0.0.1 enterprise.gramax.local' >> /etc/hosts
#     - ./install-deps.sh --ci
#     - cd scripts/enterprise
#     - chmod +x ./install-caddy.sh
#     - ./install-caddy.sh
#     - cd test-local
#     - ./start-enterprise.sh &
#   script:
#     - cd ../../..
#     - nice -n 15 ionice -c 3 npm --prefix apps/browser run build
#     - nice -n 15 ionice -c 3 npm --prefix apps/browser run start &
#     - nice -n -15 ionice -c 2 -n 3 npm --prefix e2e run test:enterprise

# artifacts:
#   when: always
#   expire_in: 1 day
#   paths:
#     - e2e/report/
#   reports:
#     junit: e2e/junit*.xml
