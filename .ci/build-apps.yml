build-desktop-web:
  extends: .template.build.apps
  image: gitlab.ics-it.ru:4567/ics/doc-reader:base-image-$BRANCH
  tags:
    - kubernetes01-gramax
  variables:
    KUBERNETES_MEMORY_REQUEST: '4Gi'
    KUBERNETES_CPU_REQUEST: '1.5'
    KUBERNETES_CPU_LIMIT: '2'
  script:
    - rm -r ./services
    - ./install-deps.sh --ci
    - ./gx build --web
  artifacts:
    paths:
      - ./apps-build-artifacts

build-desktop-windows:
  extends: .template.build.apps
  needs:
    - job: build-desktop-web
      artifacts: true
  tags:
    - shell-macos-arm64v8
  script:
    - ./gx make-icons
    - ./gx build --windows-x86_64 --upload

build-desktop-macos:
  extends: .template.build.apps
  needs:
    - job: build-desktop-web
      artifacts: true
  tags:
    - shell-macos-arm64v8
  script:
    - ./gx make-icons
    - ./gx build --darwin-aarch64 --darwin-x86_64 --upload

build-desktop-linux:
  extends: .template.build.apps
  image: gitlab.ics-it.ru:4567/ics/doc-reader:linux-tauri-$BRANCH
  needs:
    - job: build-desktop-web
      artifacts: true
  tags:
    - kubernetes01-gramax-5ghz
  variables:
    RUSTUP_PERMIT_COPY_RENAME: 1
    KUBERNETES_MEMORY_REQUEST: '2.5Gi'
    KUBERNETES_CPU_REQUEST: '2'
    KUBERNETES_CPU_LIMIT: '5'
  script:
    - ./gx make-icons
    - ./gx build --linux-x86_64 --upload

build-mobile-android:
  extends: .template.build.apps
  needs:
    - job: build-desktop-web
      artifacts: true
  tags:
    - shell-macos-arm64v8
  when: manual
  rules:
    - if: $CI_COMMIT_BRANCH == 'develop'
  script:
    - ./gx make-icons
    - ./gx build --android --upload
