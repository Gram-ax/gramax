rstests:
  stage: test
  interruptible: true
  tags:
    - shell-macos-arm64v8
  rules:
    - !reference [.condition, tests, base, rules]
    - !reference [.condition, ci, rules]
    - !reference [.condition, tests, rstests, rules]
  script:
    - ./gx make-icons
    - cargo test --all-targets -p spa --tests --manifest-path ./Cargo.toml
    - cargo test --all-targets -p gramax-git --tests --manifest-path ./Cargo.toml

biome:
  stage: test
  interruptible: true
  image: gitlab.ics-it.ru:4567/ics/doc-reader:base-image-$BRANCH
  tags:
    - kubernetes01-gramax
  variables:
    GIT_DEPTH: 2
    KUBERNETES_MEMORY_REQUEST: '512Mi'
    KUBERNETES_CPU_REQUEST: '0.2'
    KUBERNETES_CPU_LIMIT: '3'
  rules:
    - if: '$CI_COMMIT_TITLE =~ /!?\[?(skip|no)[ -]biome\]?/i'
      when: never
    - !reference [.condition, tests, base, rules]
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - !reference [.condition, core, rules]
  before_script:
    - ./install-deps.sh --ci
    - |
      if [ -v CI_MERGE_REQUEST_TARGET_BRANCH_NAME ]; then
        target="${CI_MERGE_REQUEST_TARGET_BRANCH_NAME:-master}"
        git fetch --depth 1 origin "$target"
        git diff --name-only --diff-filter=ACMR origin/"$target" HEAD > .changed_files

        if [[ $(wc -l < .changed_files) -ge 50 ]]; then
          cat .changed_files
        fi
      fi
  script:
    - |
      if [ -f .changed_files ]; then
        bun run biome ci --no-errors-on-unmatched --error-on-warnings --files-ignore-unknown=true -- "$(cat .changed_files)"
      fi
    - bun run biome ci --diagnostic-level error
  after_script:
    - cat .changed_files

unit-tests:
  extends: .template.tests
  stage: test
  image: gitlab.ics-it.ru:4567/ics/doc-reader:base-image-$BRANCH
  tags:
    - kubernetes01-gramax-5ghz
  rules:
    - !reference [.condition, tests, base, rules]
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - !reference [.condition, core, rules]
  variables:
    CARGO_HOME: '$CI_PROJECT_DIR/.cargo'
    GES_URL: https://enterprise.gramax.local
    NODE_TLS_REJECT_UNAUTHORIZED: 0
    ENTERPRISE_STORAGE_TYPE: local
    GIT_SERVER_TOKEN: $ENTERPRISE_GIT_SERVER_TOKEN
    GIT_PROJECT_PATH: $ENTERPRISE_GIT_PROJECT_PATH
    KEYCLOAK_CLIENT_SECRET: $E2E_KEYCLOAK_CLIENT_SECRET
    KUBERNETES_MEMORY_REQUEST: '2Gi'
    KUBERNETES_CPU_REQUEST: '2'
    KUBERNETES_CPU_LIMIT: '5'
    DEBUG_JEST: true
  before_script:
    - ./install-deps.sh --ci --node
    - echo '127.0.0.1 enterprise.gramax.local' >> /etc/hosts
    - ./scripts/enterprise/install-caddy.sh
    - (cd ./scripts/enterprise/test-local; ./start-enterprise.sh > /dev/null 2>&1 &) &
  script:
    - bun run tsc --incremental false
    - bun run test:unit
    - bun run test:int
    - bun run test:ges
    - bun test --cwd services
  artifacts:
    reports:
      junit: junit.xml

web-e2e-pw:
  extends: .template.e2e-pw
  script:
    - nice -n 15 ionice -c 3 bun run --cwd e2e-pw web:build
    - bun run --cwd e2e-pw web:start &
    - nice -n -15 bun run --cwd e2e-pw web:ci

static-e2e-pw:
  extends: .template.e2e-pw
  variables:
    PORT: 6002
  script:
    - git clone https://git:$GX_E2E_GITLAB_TOKEN@$GX_E2E_GITLAB_URL/$GX_E2E_GITLAB_GROUP/$GX_E2E_GITLAB_TEST_REPO.git
    - nice -n 20 ionice -c 3 bun run --cwd apps/gramax-cli build
    - nice -n 20 ionice -c 3 bun run apps/gramax-cli/dist/index.js build -s "$GX_E2E_GITLAB_TEST_REPO" --skip-check
    # - npx http-server build &
    # - nice -n -15 ionice -c 2 -n 3 npm --prefix e2e run test:static
    - n use 20
    - nice -n 20 ionice -c 2 -n 3 npx apps/gramax-cli/dist build -s "$GX_E2E_GITLAB_TEST_REPO" --skip-check

docportal-e2e-pw:
  extends: .template.e2e-pw
  variables:
    PORT: 6003
    ADMIN_PASSWORD: 1
    ADMIN_LOGIN: 1
  script:
    - nice -n 10 ionice -c 3 bun run --cwd e2e-pw docportal:build-git
    - nice -n 10 ionice -c 3 bun run --cwd e2e-pw docportal:build
    - bun run --cwd e2e-pw docportal:start &
    - nice -n -15 ionice -c 2 bun run --cwd e2e-pw docportal:ci

scan-containers:
  extends: container_scanning
  interruptible: true
  tags:
    - kubernetes01-gramax
  rules: !reference [.condition, build, onlymaster, rules]
  variables:
    GIT_STRATEGY: fetch
  parallel:
    matrix:
      - CS_IMAGE: 'docker.io/gramax/docportal'
        CS_DOCKERFILE_PATH: ./apps/next/next.Dockerfile
      - CS_IMAGE: 'docker.io/gramax/editor'
        CS_DOCKERFILE_PATH: ./apps/browser/Dockerfile

detect-secrets:
  extends: secret_detection
  interruptible: true
  tags:
    - kubernetes01-gramax
  rules:
    - !reference [.condition, tests, base, rules]
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - !reference [.condition, core, rules]

container_scanning:
  rules:
    - when: never

secret_detection:
  rules:
    - when: never
